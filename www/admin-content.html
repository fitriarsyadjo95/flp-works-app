<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Management - FLP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1C1C1F; }
        ::-webkit-scrollbar-thumb { background: #3C3C3F; border-radius: 4px; }

        @media (max-width: 1024px) {
            #adminSidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            #adminSidebar:not(.-translate-x-full) { transform: translateX(0); }
            main { margin-left: 0 !important; }
            #adminTopbar { left: 0 !important; }
        }
    </style>
</head>
<body class="bg-bg text-label-primary font-sf-ui">
    <!-- Sidebar and Topbar injected by admin-layout.js -->

    <!-- Main Content -->
    <main class="ml-64 pt-20 pb-8 px-6 max-w-7xl">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Content Management</h1>
                <p class="text-label-secondary">Manage courses, videos, and educational content</p>
            </div>
            <button onclick="openCreateModal()" class="px-6 py-3 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <path d="M12 4v16m8-8H4"></path>
                </svg>
                New Course
            </button>
        </div>

        <!-- Filters -->
        <div class="bg-bg-elevated rounded-xl p-4 border border-separator/20 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="filterCategory" onchange="loadCourses()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">All Categories</option>
                    <option value="Strategy">Strategy</option>
                    <option value="Psychology">Psychology</option>
                    <option value="MT4">MT4</option>
                    <option value="General">General</option>
                </select>
                <select id="filterDifficulty" onchange="loadCourses()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">All Difficulties</option>
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                </select>
                <select id="filterPublished" onchange="loadCourses()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">All Status</option>
                    <option value="1">Published</option>
                    <option value="0">Unpublished</option>
                </select>
                <button onclick="loadCourses()" class="px-4 py-2 bg-info/20 text-info rounded-lg hover:bg-info/30 transition-colors">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Courses Grid -->
        <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center text-label-tertiary py-12">Loading courses...</div>
        </div>
    </main>

    <!-- Create/Edit Modal -->
    <div id="courseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-bg-elevated rounded-xl border border-separator/20 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-separator/20 flex justify-between items-center sticky top-0 bg-bg-elevated">
                <h2 class="text-xl font-semibold text-white" id="modalTitle">Create New Course</h2>
                <button onclick="closeModal()" class="text-label-secondary hover:text-white">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-6 h-6">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="courseForm" class="p-6 space-y-4">
                <input type="hidden" id="courseId" />

                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Title *</label>
                    <input type="text" id="courseTitle" required class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Description</label>
                    <textarea id="courseDescription" rows="3" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-label-primary mb-2">Category</label>
                        <select id="courseCategory" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="General">General</option>
                            <option value="Strategy">Strategy</option>
                            <option value="Psychology">Psychology</option>
                            <option value="MT4">MT4</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-label-primary mb-2">Difficulty</label>
                        <select id="courseDifficulty" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-label-primary mb-2">Duration (e.g. 12:45)</label>
                        <input type="text" id="courseDuration" placeholder="12:45" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-label-primary mb-2">Order</label>
                        <input type="number" id="courseOrder" value="0" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Tags (comma separated)</label>
                    <input type="text" id="courseTags" placeholder="strategy, beginner, forex" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Thumbnail URL</label>
                    <input type="url" id="courseThumbnail" placeholder="https://..." class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Video URL</label>
                    <input type="url" id="courseVideo" placeholder="https://..." class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="coursePublished" checked class="w-4 h-4 text-primary bg-bg-secondary border-separator rounded focus:ring-2 focus:ring-primary" />
                    <label for="coursePublished" class="ml-2 text-sm text-label-primary">Published (visible to users)</label>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-primary text-black font-semibold py-3 rounded-lg hover:bg-primary/90 transition-colors">
                        Save Course
                    </button>
                    <button type="button" onclick="closeModal()" class="px-6 py-3 bg-bg-secondary text-white rounded-lg hover:bg-bg-tertiary transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let courses = [];
        let editingId = null;

        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            if (!token || !expires || Date.now() > parseInt(expires)) {
                window.location.href = '/admin-login.html';
                return null;
            }
            return token;
        }

        async function loadCourses() {
            const token = checkAuth();
            if (!token) return;

            const category = document.getElementById('filterCategory').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const is_published = document.getElementById('filterPublished').value;

            try {
                let url = '/api/content/courses?';
                if (category) url += `category=${category}&`;
                if (difficulty) url += `difficulty=${difficulty}&`;
                if (is_published) url += `is_published=${is_published}&`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    courses = data.courses;
                    renderCourses(courses);
                }
            } catch (error) {
                console.error('Failed to load courses:', error);
            }
        }

        function renderCourses(courses) {
            const grid = document.getElementById('coursesGrid');

            if (!courses || courses.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-label-tertiary py-12">No courses found</div>';
                return;
            }

            grid.innerHTML = courses.map(course => `
                <div class="bg-bg-elevated rounded-xl overflow-hidden border border-separator/20 hover:border-primary/30 transition-colors">
                    <div class="aspect-video bg-gradient-to-br from-blue-600/20 to-purple-700/20 flex items-center justify-center relative">
                        ${course.thumbnail_url ?
                            `<img src="${course.thumbnail_url}" alt="${course.title}" class="w-full h-full object-cover" />` :
                            `<svg viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-label-tertiary">
                                <path d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"></path>
                            </svg>`
                        }
                        ${course.duration ? `<div class="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs">${course.duration}</div>` : ''}
                        <div class="absolute top-2 left-2">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${course.is_published ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                                ${course.is_published ? 'Published' : 'Draft'}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-white mb-2 line-clamp-2">${course.title}</h3>
                        <p class="text-sm text-label-secondary mb-3 line-clamp-2">${course.description || 'No description'}</p>
                        <div class="flex gap-2 mb-3">
                            <span class="px-2 py-1 rounded text-xs bg-primary/20 text-primary">${course.category}</span>
                            <span class="px-2 py-1 rounded text-xs bg-info/20 text-info">${course.difficulty}</span>
                        </div>
                        <div class="text-xs text-label-tertiary mb-3">
                            Views: ${course.views} | Order: ${course.order_index}
                        </div>
                        <div class="flex gap-2">
                            <a href="admin-course-edit.html?id=${course.id}" class="flex-1 px-3 py-2 bg-primary/20 text-primary rounded-lg hover:bg-primary/30 transition-colors text-sm font-medium text-center">
                                Edit
                            </a>
                            <button onclick="deleteCourse('${course.id}')" class="px-3 py-2 bg-danger/20 text-danger rounded-lg hover:bg-danger/30 transition-colors text-sm font-medium">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Create New Course';
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
            document.getElementById('coursePublished').checked = true;
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function editCourse(id) {
            const course = courses.find(c => c.id === id);
            if (!course) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Course';
            document.getElementById('courseId').value = course.id;
            document.getElementById('courseTitle').value = course.title;
            document.getElementById('courseDescription').value = course.description || '';
            document.getElementById('courseCategory').value = course.category;
            document.getElementById('courseDifficulty').value = course.difficulty;
            document.getElementById('courseDuration').value = course.duration || '';
            document.getElementById('courseOrder').value = course.order_index;
            document.getElementById('courseTags').value = course.tags || '';
            document.getElementById('courseThumbnail').value = course.thumbnail_url || '';
            document.getElementById('courseVideo').value = course.video_url || '';
            document.getElementById('coursePublished').checked = course.is_published == 1;
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('courseModal').classList.add('hidden');
            editingId = null;
        }

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const courseData = {
                title: document.getElementById('courseTitle').value,
                description: document.getElementById('courseDescription').value,
                category: document.getElementById('courseCategory').value,
                difficulty: document.getElementById('courseDifficulty').value,
                duration: document.getElementById('courseDuration').value,
                order_index: parseInt(document.getElementById('courseOrder').value),
                tags: document.getElementById('courseTags').value,
                thumbnail_url: document.getElementById('courseThumbnail').value,
                video_url: document.getElementById('courseVideo').value,
                is_published: document.getElementById('coursePublished').checked ? 1 : 0
            };

            try {
                const url = editingId ? `/api/content/courses/${editingId}` : '/api/content/courses';
                const method = editingId ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(editingId ? 'Course updated!' : 'Course created!');
                    closeModal();
                    loadCourses();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save course');
            }
        });

        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course?')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/content/courses/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Course deleted!');
                    loadCourses();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete course');
            }
        }

        // Close modal on backdrop click
        document.getElementById('courseModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        loadCourses();
    </script>

    <!-- Admin Layout with Sidebar -->
    <script src="assets/js/admin-layout.js"></script>
    <script>
        const adminLayout = new AdminLayout('content');
        adminLayout.setPageTitle('Content Management', 'Manage courses and educational content');
    </script>
</body>
</html>
