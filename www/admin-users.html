<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - FLP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1C1C1F; }
        ::-webkit-scrollbar-thumb { background: #3C3C3F; border-radius: 4px; }

        @media (max-width: 1024px) {
            #adminSidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            #adminSidebar:not(.-translate-x-full) { transform: translateX(0); }
            main { margin-left: 0 !important; }
            #adminTopbar { left: 0 !important; }
        }
    </style>
</head>
<body class="bg-bg text-label-primary font-sf-ui">
    <!-- Sidebar and Topbar injected by admin-layout.js -->

    <!-- Main Content -->
    <main class="ml-64 pt-20 pb-8 px-6 max-w-7xl">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">User Management</h1>
            <p class="text-label-secondary">View and manage app users</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Total Users</div>
                <div class="text-3xl font-bold text-white" id="totalUsers">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Premium Users</div>
                <div class="text-3xl font-bold text-primary" id="premiumUsers">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">New Today</div>
                <div class="text-3xl font-bold text-success" id="newToday">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Active Today</div>
                <div class="text-3xl font-bold text-info" id="activeToday">0</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-bg-elevated rounded-xl p-4 border border-separator/20 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="filterPremium" onchange="loadUsers()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">All Users</option>
                    <option value="1">Premium Only</option>
                    <option value="0">Free Only</option>
                </select>
                <input type="text" id="searchUsers" placeholder="Search by email..." onkeyup="filterUsers()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                <button onclick="loadUsers()" class="px-4 py-2 bg-info/20 text-info rounded-lg hover:bg-info/30 transition-colors">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-bg-elevated rounded-xl border border-separator/20 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-bg-secondary border-b border-separator/30">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">User</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Referral</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Joined</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Last Login</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-label-secondary uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable" class="divide-y divide-separator/20">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-label-tertiary">
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center text-sm text-label-secondary">
            Showing <span id="userCount">0</span> users
        </div>
    </main>

    <!-- Push Notification Modal -->
    <div id="notifModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-bg-elevated rounded-xl border border-separator/20 max-w-lg w-full">
            <div class="p-6 border-b border-separator/20">
                <h2 class="text-xl font-semibold text-white">Send Notification</h2>
            </div>
            <form id="notifForm" class="p-6 space-y-4">
                <input type="hidden" id="notifUserId" />
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Title *</label>
                    <input type="text" id="notifTitle" required class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Message *</label>
                    <textarea id="notifMessage" required rows="3" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Type</label>
                    <select id="notifType" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="system">System</option>
                        <option value="premium">Premium</option>
                        <option value="course">Course</option>
                        <option value="signal">Signal</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-black font-semibold py-3 rounded-lg hover:bg-primary/90">
                        Send
                    </button>
                    <button type="button" onclick="closeNotifModal()" class="px-6 py-3 bg-bg-secondary text-white rounded-lg hover:bg-bg-tertiary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let users = [];
        let allUsers = [];

        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            if (!token || !expires || Date.now() > parseInt(expires)) {
                window.location.href = '/admin-login.html';
                return null;
            }
            return token;
        }

        async function loadUsers() {
            const token = checkAuth();
            if (!token) return;

            const is_premium = document.getElementById('filterPremium').value;

            try {
                let url = '/api/content/users?';
                if (is_premium) url += `is_premium=${is_premium}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    allUsers = data.users;
                    users = allUsers;
                    updateStats(data.stats);
                    renderUsers(users);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
            document.getElementById('premiumUsers').textContent = stats.premiumUsers || 0;
            document.getElementById('newToday').textContent = stats.newToday || 0;
            document.getElementById('activeToday').textContent = stats.activeToday || 0;
        }

        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            users = allUsers.filter(u =>
                u.email.toLowerCase().includes(search) ||
                (u.username && u.username.toLowerCase().includes(search))
            );
            renderUsers(users);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTable');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-label-tertiary">No users found</td></tr>';
                document.getElementById('userCount').textContent = '0';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-bg-secondary transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-semibold text-white">${user.email}</div>
                        ${user.username ? `<div class="text-xs text-label-tertiary">${user.username}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                            user.is_premium ? 'bg-primary/20 text-primary' : 'bg-gray-500/20 text-gray-400'
                        }">
                            ${user.is_premium ? 'ðŸ’Ž Premium' : 'Free'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${user.referral_code ? `
                            <div class="text-xs text-white font-mono">${user.referral_code}</div>
                            ${user.referred_by ? `<div class="text-xs text-label-tertiary">By: ${user.referred_by}</div>` : ''}
                        ` : '<span class="text-label-tertiary text-xs">None</span>'}
                    </td>
                    <td class="px-6 py-4 text-sm text-label-secondary">
                        ${formatDate(user.created_at)}
                    </td>
                    <td class="px-6 py-4 text-sm text-label-secondary">
                        ${user.last_login ? formatDate(user.last_login) : 'Never'}
                    </td>
                    <td class="px-6 py-4 text-right text-sm">
                        ${!user.is_premium ? `
                            <button onclick="upgradeToPremium('${user.id}')" class="text-primary hover:text-primary/80 font-medium mr-3">
                                Upgrade
                            </button>
                        ` : ''}
                        <button onclick="sendNotification('${user.id}', '${user.email}')" class="text-info hover:text-info/80 font-medium mr-3">
                            Notify
                        </button>
                        <button onclick="deleteUser('${user.id}')" class="text-danger hover:text-danger/80 font-medium">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('userCount').textContent = users.length;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        async function upgradeToPremium(userId) {
            if (!confirm('Upgrade this user to Premium?')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/content/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_premium: 1 })
                });

                const data = await response.json();
                if (data.success) {
                    alert('User upgraded to Premium!');
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Upgrade error:', error);
                alert('Failed to upgrade user');
            }
        }

        function sendNotification(userId, email) {
            document.getElementById('notifUserId').value = userId;
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            document.getElementById('notifModal').classList.remove('hidden');
        }

        function closeNotifModal() {
            document.getElementById('notifModal').classList.add('hidden');
        }

        document.getElementById('notifForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const notifData = {
                title: document.getElementById('notifTitle').value,
                message: document.getElementById('notifMessage').value,
                type: document.getElementById('notifType').value,
                user_id: document.getElementById('notifUserId').value,
                is_global: 0
            };

            try {
                const response = await fetch('/api/content/notifications', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notifData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Notification sent!');
                    closeNotifModal();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Send error:', error);
                alert('Failed to send notification');
            }
        });

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/content/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    alert('User deleted!');
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete user');
            }
        }

        document.getElementById('notifModal').addEventListener('click', function(e) {
            if (e.target === this) closeNotifModal();
        });

        loadUsers();
    </script>

    <script src="assets/js/admin-layout.js"></script>
    <script>
        const adminLayout = new AdminLayout('users');
        adminLayout.setPageTitle('User Management', 'View and manage app users');
    </script>
</body>
</html>
