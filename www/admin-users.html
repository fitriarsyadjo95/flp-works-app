<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - FLP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1C1C1F; }
        ::-webkit-scrollbar-thumb { background: #3C3C3F; border-radius: 4px; }

        @media (max-width: 1024px) {
            #adminSidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            #adminSidebar:not(.-translate-x-full) { transform: translateX(0); }
            main { margin-left: 0 !important; }
            #adminTopbar { left: 0 !important; }
        }
    </style>
</head>
<body class="bg-bg text-label-primary font-sf-ui">
    <!-- Sidebar and Topbar injected by admin-layout.js -->

    <!-- Main Content -->
    <main class="ml-64 pt-20 pb-8 px-6 max-w-7xl">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">User Management</h1>
            <p class="text-label-secondary">View and manage app users</p>
        </div>

        <!-- Telegram Upgrade Link Configuration -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20 mb-6">
            <h2 class="text-lg font-semibold text-white mb-4">Telegram Upgrade Link</h2>
            <p class="text-label-secondary text-sm mb-4">This link is shown to free users when they try to access premium features (e.g., signals page)</p>
            <div class="flex gap-3">
                <input type="text" id="telegramLink" placeholder="https://t.me/yourusername" class="flex-1 px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                <button onclick="saveTelegramLink()" class="px-6 py-2 bg-primary text-black font-semibold rounded-lg hover:bg-primary/90 transition-colors">
                    Save Link
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Total Users</div>
                <div class="text-3xl font-bold text-white" id="totalUsers">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Pro Members</div>
                <div class="text-3xl font-bold text-primary" id="proUsers">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">Free Members</div>
                <div class="text-3xl font-bold text-success" id="freeUsers">0</div>
            </div>
            <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
                <div class="text-label-secondary text-sm mb-2">New This Week</div>
                <div class="text-3xl font-bold text-info" id="newThisWeek">0</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-bg-elevated rounded-xl p-4 border border-separator/20 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="filterMembership" onchange="loadSettingsUsers()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">All Users</option>
                    <option value="pro">Pro Members</option>
                    <option value="free">Free Members</option>
                </select>
                <input type="text" id="searchUsers" placeholder="Search by username or email..." onkeyup="filterSettingsUsers()" class="px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                <button onclick="loadSettingsUsers()" class="px-4 py-2 bg-info/20 text-info rounded-lg hover:bg-info/30 transition-colors">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-bg-elevated rounded-xl border border-separator/20 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-bg-secondary border-b border-separator/30">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">User</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Membership</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Pro Since</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase">Joined</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-label-secondary uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable" class="divide-y divide-separator/20">
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-label-tertiary">
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center text-sm text-label-secondary">
            Showing <span id="userCount">0</span> users
        </div>
    </main>

    <!-- Push Notification Modal -->
    <div id="notifModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-bg-elevated rounded-xl border border-separator/20 max-w-lg w-full">
            <div class="p-6 border-b border-separator/20">
                <h2 class="text-xl font-semibold text-white">Send Notification</h2>
            </div>
            <form id="notifForm" class="p-6 space-y-4">
                <input type="hidden" id="notifUserId" />
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Title *</label>
                    <input type="text" id="notifTitle" required class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Message *</label>
                    <textarea id="notifMessage" required rows="3" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-label-primary mb-2">Type</label>
                    <select id="notifType" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="system">System</option>
                        <option value="premium">Premium</option>
                        <option value="course">Course</option>
                        <option value="signal">Signal</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-black font-semibold py-3 rounded-lg hover:bg-primary/90">
                        Send
                    </button>
                    <button type="button" onclick="closeNotifModal()" class="px-6 py-3 bg-bg-secondary text-white rounded-lg hover:bg-bg-tertiary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let settingsUsers = [];
        let allSettingsUsers = [];

        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            if (!token || !expires || Date.now() > parseInt(expires)) {
                window.location.href = '/admin-login.html';
                return null;
            }
            return token;
        }

        // Load Telegram link on page load
        async function loadTelegramLink() {
            try {
                const response = await fetch('/api/settings/config/telegram_upgrade_link');
                const data = await response.json();
                if (data.success && data.value) {
                    document.getElementById('telegramLink').value = data.value;
                }
            } catch (error) {
                console.error('Failed to load Telegram link:', error);
            }
        }

        // Save Telegram link
        async function saveTelegramLink() {
            const link = document.getElementById('telegramLink').value.trim();

            if (!link) {
                alert('Please enter a valid Telegram link');
                return;
            }

            if (!link.startsWith('https://t.me/')) {
                alert('Telegram link must start with https://t.me/');
                return;
            }

            try {
                const response = await fetch('/api/settings/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: 'telegram_upgrade_link',
                        value: link
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Telegram link updated successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save Telegram link');
            }
        }

        // Load users from settings database
        async function loadSettingsUsers() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/settings/users');
                const data = await response.json();

                if (data.success) {
                    allSettingsUsers = data.users;

                    // Apply membership filter
                    const filter = document.getElementById('filterMembership').value;
                    if (filter) {
                        settingsUsers = allSettingsUsers.filter(u => u.membershipTier === filter);
                    } else {
                        settingsUsers = allSettingsUsers;
                    }

                    updateSettingsStats(allSettingsUsers);
                    renderSettingsUsers(settingsUsers);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        function updateSettingsStats(users) {
            const totalUsers = users.length;
            const proUsers = users.filter(u => u.isPro).length;
            const freeUsers = users.filter(u => !u.isPro).length;

            // Calculate new this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const newThisWeek = users.filter(u => new Date(u.createdAt) > oneWeekAgo).length;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('proUsers').textContent = proUsers;
            document.getElementById('freeUsers').textContent = freeUsers;
            document.getElementById('newThisWeek').textContent = newThisWeek;
        }

        function filterSettingsUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            settingsUsers = allSettingsUsers.filter(u =>
                u.email.toLowerCase().includes(search) ||
                u.username.toLowerCase().includes(search) ||
                u.userId.toLowerCase().includes(search)
            );
            renderSettingsUsers(settingsUsers);
        }

        function renderSettingsUsers(users) {
            const tbody = document.getElementById('usersTable');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-label-tertiary">No users found</td></tr>';
                document.getElementById('userCount').textContent = '0';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-bg-secondary transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-semibold text-white">${user.username}</div>
                        <div class="text-xs text-label-tertiary">${user.email || 'N/A'}</div>
                        <div class="text-xs text-label-tertiary font-mono mt-1">${user.userId}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                            user.isPro ? 'bg-primary/20 text-primary' : 'bg-gray-500/20 text-gray-400'
                        }">
                            ${user.isPro ? '⭐ Pro' : 'Free'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-label-secondary">
                        ${user.proSince ? formatDate(user.proSince) : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-label-secondary">
                        ${formatDate(user.createdAt)}
                    </td>
                    <td class="px-6 py-4 text-right text-sm">
                        <button onclick="toggleMembership('${user.userId}', ${!user.isPro})" class="px-3 py-1.5 rounded-lg font-medium transition-colors ${
                            user.isPro
                                ? 'bg-gray-500/20 text-gray-400 hover:bg-gray-500/30'
                                : 'bg-primary/20 text-primary hover:bg-primary/30'
                        }">
                            ${user.isPro ? 'Downgrade to Free' : 'Upgrade to Pro'}
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('userCount').textContent = users.length;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        async function toggleMembership(userId, isPro) {
            const action = isPro ? 'upgrade to Pro' : 'downgrade to Free';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;

            try {
                const response = await fetch(`/api/settings/membership/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isPro })
                });

                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    loadSettingsUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Toggle membership error:', error);
                alert('Failed to update membership');
            }
        }

        function closeNotifModal() {
            document.getElementById('notifModal').classList.add('hidden');
        }

        document.getElementById('notifModal').addEventListener('click', function(e) {
            if (e.target === this) closeNotifModal();
        });

        // Initialize
        loadTelegramLink();
        loadSettingsUsers();
    </script>

    <script src="assets/js/admin-layout.js"></script>
    <script>
        const adminLayout = new AdminLayout('users');
        adminLayout.setPageTitle('User Management', 'View and manage app users');
    </script>
</body>
</html>
