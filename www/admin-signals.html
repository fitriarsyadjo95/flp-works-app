<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0B0B0B" />
    <title>Signal Management - FLP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1C1C1F; }
        ::-webkit-scrollbar-thumb { background: #3C3C3F; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4C4C4F; }

        @media (max-width: 1024px) {
            #adminSidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            #adminSidebar:not(.-translate-x-full) {
                transform: translateX(0);
            }
            main { margin-left: 0 !important; }
            #adminTopbar { left: 0 !important; }
        }
    </style>
</head>
<body class="bg-bg text-label-primary font-sf-ui">
    <!-- Sidebar and Topbar injected by admin-layout.js -->

    <!-- Main Content -->
    <main class="ml-64 pt-20 pb-8 px-6 max-w-7xl">
        <!-- Header with Actions -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Signal Management</h1>
                <p class="text-label-secondary">View, edit, and manage all trading signals</p>
            </div>
            <div class="flex gap-3">
                <button onclick="refreshSignals()" class="px-4 py-2 bg-bg-secondary text-white rounded-lg hover:bg-bg-tertiary transition-colors flex items-center gap-2">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
                <button onclick="exportSignals()" class="px-4 py-2 bg-info/20 text-info rounded-lg hover:bg-info/30 transition-colors flex items-center gap-2">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export CSV
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Status</label>
                    <select id="filterStatus" onchange="loadSignals()" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">All Signals</option>
                        <option value="active">Active Only</option>
                        <option value="closed_win">Closed - Win</option>
                        <option value="closed_loss">Closed - Loss</option>
                    </select>
                </div>

                <!-- Pair Filter -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Currency Pair</label>
                    <select id="filterPair" onchange="loadSignals()" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">All Pairs</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Sort By</label>
                    <select id="sortBy" onchange="loadSignals()" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="createdAt">Date Created</option>
                        <option value="confidence">Confidence</option>
                        <option value="risk">Risk Level</option>
                    </select>
                </div>

                <!-- Limit -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Show</label>
                    <select id="limitCount" onchange="loadSignals()" class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="50">50 signals</option>
                        <option value="100">100 signals</option>
                        <option value="200">200 signals</option>
                        <option value="500">500 signals</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Signals Table -->
        <div class="bg-bg-elevated rounded-xl border border-separator/20 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-bg-secondary border-b border-separator/30">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Pair</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Action</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Entry</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">TP/SL</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Confidence</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Profit</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-label-secondary uppercase tracking-wider">Created</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-label-secondary uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="signalsTable" class="divide-y divide-separator/20">
                        <!-- Signals will be dynamically added here -->
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-label-tertiary">
                                Loading signals...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Info -->
        <div class="mt-4 text-center text-sm text-label-secondary">
            Showing <span id="signalCount">0</span> signals
        </div>
    </main>

    <!-- Signal Details Modal -->
    <div id="signalModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-bg-elevated rounded-xl border border-separator/20 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-separator/20 flex justify-between items-center sticky top-0 bg-bg-elevated">
                <h2 class="text-xl font-semibold text-white">Signal Details</h2>
                <button onclick="closeModal()" class="text-label-secondary hover:text-white">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-6 h-6">
                        <path d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Content will be dynamically added -->
            </div>
        </div>
    </div>

    <script>
        let currentSignals = [];
        let selectedSignal = null;

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');

            if (!token || !expires || Date.now() > parseInt(expires)) {
                window.location.href = '/admin-login.html';
                return null;
            }

            return token;
        }

        // Load signals
        async function loadSignals() {
            const token = checkAuth();
            if (!token) return;

            const status = document.getElementById('filterStatus').value;
            const pair = document.getElementById('filterPair').value;
            const limit = document.getElementById('limitCount').value;

            try {
                let url = `/api/admin/signals?limit=${limit}`;
                if (status) url += `&status=${status}`;
                if (pair) url += `&pair=${pair}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = '/admin-login.html';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    currentSignals = data.signals;
                    updatePairFilter(data.filters.pairs);
                    renderSignalsTable(data.signals);
                    document.getElementById('signalCount').textContent = data.count;
                }
            } catch (error) {
                console.error('Failed to load signals:', error);
            }
        }

        // Update pair filter dropdown
        function updatePairFilter(pairs) {
            const select = document.getElementById('filterPair');
            const currentValue = select.value;

            // Keep "All Pairs" option
            select.innerHTML = '<option value="">All Pairs</option>';

            pairs.forEach(pair => {
                const option = document.createElement('option');
                option.value = pair;
                option.textContent = pair;
                select.appendChild(option);
            });

            // Restore selection
            select.value = currentValue;
        }

        // Render signals table
        function renderSignalsTable(signals) {
            const tbody = document.getElementById('signalsTable');

            if (!signals || signals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-label-tertiary">
                            No signals found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = signals.map(signal => {
                const statusColor = {
                    'active': 'bg-info/20 text-info',
                    'closed_win': 'bg-success/20 text-success',
                    'closed_loss': 'bg-danger/20 text-danger'
                }[signal.status] || 'bg-gray-500/20 text-gray-400';

                const profitDisplay = signal.profitPercent != null
                    ? `<span class="${signal.profitPercent >= 0 ? 'text-success' : 'text-danger'}">${signal.profitPercent >= 0 ? '+' : ''}${signal.profitPercent.toFixed(2)}%</span>`
                    : '<span class="text-label-tertiary">-</span>';

                return `
                    <tr class="hover:bg-bg-secondary transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-semibold text-white">${signal.pair}</div>
                            <div class="text-xs text-label-tertiary">${signal.source || 'RiskCompass'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${
                                signal.action === 'BUY' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'
                            }">
                                ${signal.action}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-white">${signal.entry.toFixed(signal.entry < 10 ? 4 : 2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="text-success">${signal.takeProfit.toFixed(signal.takeProfit < 10 ? 4 : 2)}</div>
                            <div class="text-danger">${signal.stopLoss.toFixed(signal.stopLoss < 10 ? 4 : 2)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <div class="text-white font-medium">${signal.confidence || '-'}%</div>
                                ${signal.confidence ? `<div class="w-16 bg-gray-700 rounded-full h-1.5">
                                    <div class="bg-primary h-1.5 rounded-full" style="width: ${signal.confidence}%"></div>
                                </div>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${statusColor}">
                                ${signal.status.replace('_', ' ').toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${profitDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-label-secondary">
                            ${formatDate(signal.createdAt)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <button onclick="viewSignal('${signal.id}')" class="text-primary hover:text-primary/80 font-medium mr-3">
                                View
                            </button>
                            ${signal.status === 'active' ? `
                                <button onclick="closeSignalPrompt('${signal.id}')" class="text-warning hover:text-warning/80 font-medium mr-3">
                                    Close
                                </button>
                            ` : ''}
                            <button onclick="deleteSignalPrompt('${signal.id}')" class="text-danger hover:text-danger/80 font-medium">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // View signal details
        function viewSignal(signalId) {
            const signal = currentSignals.find(s => s.id === signalId);
            if (!signal) return;

            selectedSignal = signal;

            const content = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-2xl font-bold text-white">${signal.pair}</h3>
                            <p class="text-label-secondary text-sm">Signal ID: ${signal.id}</p>
                        </div>
                        <span class="px-4 py-2 rounded-lg text-sm font-semibold ${
                            signal.action === 'BUY' ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'
                        }">
                            ${signal.action}
                        </span>
                    </div>

                    <!-- Price Information -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-1">Entry Price</div>
                            <div class="text-2xl font-bold text-white">${signal.entry.toFixed(signal.entry < 10 ? 4 : 2)}</div>
                        </div>
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-1">Current Status</div>
                            <div class="text-xl font-semibold text-white">${signal.status.replace('_', ' ').toUpperCase()}</div>
                        </div>
                        <div class="bg-success/10 p-4 rounded-lg border border-success/20">
                            <div class="text-success text-sm mb-1">Take Profit</div>
                            <div class="text-xl font-bold text-success">${signal.takeProfit.toFixed(signal.takeProfit < 10 ? 4 : 2)}</div>
                        </div>
                        <div class="bg-danger/10 p-4 rounded-lg border border-danger/20">
                            <div class="text-danger text-sm mb-1">Stop Loss</div>
                            <div class="text-xl font-bold text-danger">${signal.stopLoss.toFixed(signal.stopLoss < 10 ? 4 : 2)}</div>
                        </div>
                    </div>

                    <!-- Risk & Confidence -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-2">Confidence Level</div>
                            <div class="flex items-center gap-3">
                                <div class="text-2xl font-bold text-primary">${signal.confidence || '-'}%</div>
                                <div class="flex-1">
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div class="bg-primary h-2 rounded-full" style="width: ${signal.confidence || 0}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-2">Risk Level</div>
                            <div class="text-2xl font-bold text-warning">${signal.risk || '-'}%</div>
                        </div>
                    </div>

                    ${signal.reasoning ? `
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-2">AI Analysis</div>
                            <div class="text-white">${signal.reasoning}</div>
                        </div>
                    ` : ''}

                    ${signal.profitPercent != null ? `
                        <div class="bg-bg-secondary p-4 rounded-lg">
                            <div class="text-label-secondary text-sm mb-2">Result</div>
                            <div class="flex items-center gap-4">
                                <div class="${signal.profitPercent >= 0 ? 'text-success' : 'text-danger'} text-2xl font-bold">
                                    ${signal.profitPercent >= 0 ? '+' : ''}${signal.profitPercent.toFixed(2)}%
                                </div>
                                <div class="text-label-secondary">
                                    Closed at ${signal.closePrice?.toFixed(signal.closePrice < 10 ? 4 : 2)} on ${formatDate(signal.closedAt)}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Metadata -->
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-label-secondary">Source</div>
                            <div class="text-white">${signal.source || 'RiskCompass'}</div>
                        </div>
                        <div>
                            <div class="text-label-secondary">Created At</div>
                            <div class="text-white">${formatDate(signal.createdAt)}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('signalModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('signalModal').classList.add('hidden');
            selectedSignal = null;
        }

        // Close signal prompt
        function closeSignalPrompt(signalId) {
            const signal = currentSignals.find(s => s.id === signalId);
            if (!signal) return;

            const closePrice = prompt(`Close signal ${signal.pair}\nEnter closing price:`, signal.entry);
            if (!closePrice) return;

            const status = confirm('Did the signal hit Take Profit?\nOK = Win, Cancel = Loss')
                ? 'closed_win'
                : 'closed_loss';

            closeSignal(signalId, parseFloat(closePrice), status);
        }

        // Close signal
        async function closeSignal(signalId, closePrice, status) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/admin/signals/${signalId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status,
                        closePrice,
                        closedAt: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Signal closed successfully!');
                    loadSignals();
                } else {
                    alert('Failed to close signal: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to close signal:', error);
                alert('Error closing signal');
            }
        }

        // Delete signal prompt
        function deleteSignalPrompt(signalId) {
            const signal = currentSignals.find(s => s.id === signalId);
            if (!signal) return;

            if (!confirm(`Are you sure you want to delete signal ${signal.pair} ${signal.action}?\n\nThis action cannot be undone.`)) {
                return;
            }

            deleteSignal(signalId);
        }

        // Delete signal
        async function deleteSignal(signalId) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`/api/admin/signals/${signalId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Signal deleted successfully!');
                    loadSignals();
                } else {
                    alert('Failed to delete signal: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to delete signal:', error);
                alert('Error deleting signal');
            }
        }

        // Refresh signals
        function refreshSignals() {
            loadSignals();
        }

        // Export signals
        async function exportSignals() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/signals/export/csv', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `signals-export-${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    alert('Signals exported successfully!');
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export signals');
            }
        }

        // Initialize
        loadSignals();

        // Close modal on backdrop click
        document.getElementById('signalModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <!-- Admin Layout with Sidebar -->
    <script src="assets/js/admin-layout.js"></script>
    <script>
        const adminLayout = new AdminLayout('signals');
        adminLayout.setPageTitle('Signal Management', 'View and manage all trading signals');
    </script>
</body>
</html>
