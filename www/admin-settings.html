<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0B0B0B" />
    <title>Admin Settings - FLP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1C1C1F; }
        ::-webkit-scrollbar-thumb { background: #3C3C3F; border-radius: 4px; }

        @media (max-width: 1024px) {
            #adminSidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            #adminSidebar:not(.-translate-x-full) { transform: translateX(0); }
            main { margin-left: 0 !important; }
            #adminTopbar { left: 0 !important; }
        }
    </style>
</head>
<body class="bg-bg text-label-primary font-sf-ui">
    <!-- Sidebar and Topbar injected by admin-layout.js -->

    <!-- Main Content -->
    <main class="ml-64 pt-20 pb-8 px-6 max-w-7xl">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">System Settings</h1>
            <p class="text-label-secondary">Manage system configuration and security</p>
        </div>

        <!-- API Configuration -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20 mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">API Configuration</h2>

            <div class="space-y-4">
                <!-- Current API Key -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Current Signal API Key</label>
                    <div class="flex gap-2">
                        <input
                            type="password"
                            id="apiKey"
                            value="your-secure-api-key-change-in-production"
                            readonly
                            class="flex-1 px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white"
                        />
                        <button onclick="toggleApiKey()" class="px-4 py-2 bg-bg-secondary text-white rounded-lg hover:bg-bg-tertiary transition-colors">
                            <svg id="apiKeyEye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        <button onclick="copyApiKey()" class="px-4 py-2 bg-primary text-black font-medium rounded-lg hover:bg-primary/90 transition-colors">
                            Copy
                        </button>
                    </div>
                    <p class="text-xs text-label-tertiary mt-2">
                        ⚠️ This key is used by your ASP.NET backend to send signals. Keep it secure!
                    </p>
                </div>

                <!-- Generate New Key Button -->
                <div class="flex items-center justify-between p-4 bg-warning/10 border border-warning/30 rounded-lg">
                    <div>
                        <div class="text-warning font-medium">Generate New API Key</div>
                        <div class="text-sm text-label-secondary">This will invalidate the current key</div>
                    </div>
                    <button onclick="generateNewApiKey()" class="px-4 py-2 bg-warning text-black font-medium rounded-lg hover:bg-warning/90 transition-colors">
                        Generate
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20 mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">Security Settings</h2>

            <div class="space-y-4">
                <!-- Change Password -->
                <div>
                    <label class="block text-sm font-medium text-label-secondary mb-2">Change Admin Password</label>
                    <form id="changePasswordForm" class="space-y-3">
                        <input
                            type="password"
                            id="oldPassword"
                            placeholder="Current password"
                            required
                            class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white placeholder-label-tertiary focus:outline-none focus:ring-2 focus:ring-primary"
                        />
                        <input
                            type="password"
                            id="newPassword"
                            placeholder="New password (min 8 characters)"
                            required
                            minlength="8"
                            class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white placeholder-label-tertiary focus:outline-none focus:ring-2 focus:ring-primary"
                        />
                        <input
                            type="password"
                            id="confirmPassword"
                            placeholder="Confirm new password"
                            required
                            minlength="8"
                            class="w-full px-4 py-2 bg-bg-secondary border border-separator rounded-lg text-white placeholder-label-tertiary focus:outline-none focus:ring-2 focus:ring-primary"
                        />
                        <button
                            type="submit"
                            class="w-full px-4 py-2 bg-primary text-black font-medium rounded-lg hover:bg-primary/90 transition-colors"
                        >
                            Change Password
                        </button>
                    </form>
                </div>

                <!-- Active Sessions -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-label-secondary">Active Admin Sessions</label>
                        <button onclick="loadSessions()" class="text-sm text-primary hover:text-primary/80">
                            Refresh
                        </button>
                    </div>
                    <div id="sessionsList" class="space-y-2">
                        <div class="text-center text-label-tertiary py-4">Loading sessions...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20 mb-6">
            <h2 class="text-xl font-semibold text-white mb-4">System Information</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-bg-secondary rounded-lg">
                    <div class="text-label-secondary text-sm mb-1">Node.js Version</div>
                    <div class="text-white font-semibold" id="nodeVersion">-</div>
                </div>
                <div class="p-4 bg-bg-secondary rounded-lg">
                    <div class="text-label-secondary text-sm mb-1">Environment</div>
                    <div class="text-white font-semibold">Development</div>
                </div>
                <div class="p-4 bg-bg-secondary rounded-lg">
                    <div class="text-label-secondary text-sm mb-1">Server Port</div>
                    <div class="text-white font-semibold">5001</div>
                </div>
                <div class="p-4 bg-bg-secondary rounded-lg">
                    <div class="text-label-secondary text-sm mb-1">Database</div>
                    <div class="text-white font-semibold">SQLite (signals.db)</div>
                </div>
            </div>
        </div>

        <!-- Database Management -->
        <div class="bg-bg-elevated rounded-xl p-6 border border-separator/20">
            <h2 class="text-xl font-semibold text-white mb-4">Database Management</h2>

            <div class="space-y-3">
                <div class="flex items-center justify-between p-4 bg-info/10 border border-info/30 rounded-lg">
                    <div>
                        <div class="text-info font-medium">Backup Database</div>
                        <div class="text-sm text-label-secondary">Download current database file</div>
                    </div>
                    <button onclick="backupDatabase()" class="px-4 py-2 bg-info text-black font-medium rounded-lg hover:bg-info/90 transition-colors">
                        Backup
                    </button>
                </div>

                <div class="flex items-center justify-between p-4 bg-danger/10 border border-danger/30 rounded-lg">
                    <div>
                        <div class="text-danger font-medium">Clear Old Signals</div>
                        <div class="text-sm text-label-secondary">Delete signals older than 90 days</div>
                    </div>
                    <button onclick="clearOldSignals()" class="px-4 py-2 bg-danger text-white font-medium rounded-lg hover:bg-danger/90 transition-colors">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');

            if (!token || !expires || Date.now() > parseInt(expires)) {
                window.location.href = '/admin-login.html';
                return null;
            }

            return token;
        }

        // Toggle API key visibility
        function toggleApiKey() {
            const input = document.getElementById('apiKey');
            const icon = document.getElementById('apiKeyEye');

            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `
                    <path d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"></path>
                `;
            } else {
                input.type = 'password';
                icon.innerHTML = `
                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }

        // Copy API key
        function copyApiKey() {
            const input = document.getElementById('apiKey');
            const originalType = input.type;
            input.type = 'text';
            input.select();
            document.execCommand('copy');
            input.type = originalType;

            alert('API key copied to clipboard!');
        }

        // Generate new API key
        function generateNewApiKey() {
            if (!confirm('⚠️ WARNING: Generating a new API key will immediately invalidate the current key.\n\nYour ASP.NET backend will stop working until you update it with the new key.\n\nAre you sure you want to continue?')) {
                return;
            }

            alert('Note: This is a demo. In production, this would:\n1. Generate a new secure random key\n2. Update server configuration\n3. Require restart\n\nFor now, manually update the API_KEY environment variable and restart the server.');
        }

        // Change password
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            if (newPassword.length < 8) {
                alert('New password must be at least 8 characters long!');
                return;
            }

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Password changed successfully! You will be logged out.');
                    localStorage.clear();
                    window.location.href = '/admin-login.html';
                } else {
                    alert('Failed to change password: ' + data.error);
                }
            } catch (error) {
                console.error('Password change error:', error);
                alert('Error changing password');
            }
        });

        // Load active sessions
        async function loadSessions() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/sessions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = '/admin-login.html';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    renderSessions(data.sessions);
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
                document.getElementById('sessionsList').innerHTML = '<div class="text-center text-danger py-4">Error loading sessions</div>';
            }
        }

        // Render sessions
        function renderSessions(sessions) {
            const container = document.getElementById('sessionsList');

            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<div class="text-center text-label-tertiary py-4">No active sessions</div>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="flex items-center justify-between p-3 bg-bg-secondary rounded-lg">
                    <div>
                        <div class="font-medium text-white">${session.username} <span class="text-xs text-label-secondary">(${session.role})</span></div>
                        <div class="text-xs text-label-tertiary">
                            Login: ${formatDate(session.loginAt)} | IP: ${session.ipAddress || 'Unknown'}
                        </div>
                    </div>
                    <div class="text-xs text-success">Active</div>
                </div>
            `).join('');
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Backup database
        function backupDatabase() {
            alert('Database backup feature:\n\nIn production, this would:\n1. Create a copy of signals.db\n2. Download it to your computer\n3. Include timestamp in filename\n\nFor manual backup, copy the signals.db file from the server.');
        }

        // Clear old signals
        function clearOldSignals() {
            if (!confirm('Are you sure you want to delete all closed signals older than 90 days?\n\nThis action cannot be undone.')) {
                return;
            }

            alert('This feature would delete old signals. Implementation requires a new API endpoint.');
        }

        // Initialize
        loadSessions();

        // Load system info from dashboard
        async function loadSystemInfo() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('nodeVersion').textContent = data.dashboard.system.nodeVersion;
                }
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        loadSystemInfo();
    </script>

    <script src="assets/js/admin-layout.js"></script>
    <script>
        const adminLayout = new AdminLayout('settings');
        adminLayout.setPageTitle('System Settings', 'Manage system configuration and security');
    </script>
</body>
</html>
